<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Grid</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ðŸ“¹ Video Gallery</h1>
        <a href="/record" class="btn-record">+ Record New Video</a>
      </header>

      <div class="video-grid" data-count="{{ videos|length }}">
        {% if videos %} {% for video in videos %}
        <div class="video-item" data-filename="{{ video }}">
          <video autoplay muted loop playsinline>
            <source
              src="{{ url_for('static', filename='videos/' + video) }}"
              type="video/webm"
            />
            Your browser does not support the video tag.
          </video>
        </div>
        {% endfor %} {% else %}
        <div class="no-videos">
          <p>No videos yet!</p>
          <a href="/record" class="btn-record">Record your first video</a>
        </div>
        {% endif %}
      </div>
    </div>

    <script>
      function calculateOptimalGrid() {
        const grid = document.querySelector(".video-grid");
        const videoCount = parseInt(grid.dataset.count) || 0;

        if (videoCount === 0) return;

        // Calculate grid dimensions
        const columns = Math.ceil(Math.sqrt(videoCount * 1.77)); // 1.77 â‰ˆ 16/9 aspect ratio
        const rows = Math.ceil(videoCount / columns);

        // Get available space
        const header = document.querySelector("header");
        const headerHeight = header.offsetHeight + 20; // 20px for margin
        const availableHeight = window.innerHeight - headerHeight - 40; // 40px for padding
        const availableWidth = grid.offsetWidth;

        // Calculate video dimensions with aspect ratio 16:9
        const maxVideoWidth = (availableWidth - (columns - 1) * 5) / columns; // 5px gap
        const maxVideoHeight = (availableHeight - (rows - 1) * 5) / rows; // 5px gap

        // Maintain 16:9 aspect ratio
        let videoWidth, videoHeight;
        if (maxVideoWidth / maxVideoHeight > 16 / 9) {
          // Height is the limiting factor
          videoHeight = maxVideoHeight;
          videoWidth = videoHeight * (16 / 9);
        } else {
          // Width is the limiting factor
          videoWidth = maxVideoWidth;
          videoHeight = videoWidth * (9 / 16);
        }

        // Apply styles to all video items
        const videoItems = document.querySelectorAll(".video-item");
        videoItems.forEach((item) => {
          item.style.width = `${videoWidth}px`;
          item.style.height = `${videoHeight}px`;
        });

        // Update grid layout
        grid.style.gridTemplateColumns = `repeat(${columns}, ${videoWidth}px)`;
        grid.style.gridTemplateRows = `repeat(${rows}, ${videoHeight}px)`;
      }

      // Calculate on page load
      calculateOptimalGrid();

      // Recalculate on window resize
      window.addEventListener("resize", calculateOptimalGrid);

      // Handle click on video to delete
      document.querySelectorAll(".video-item").forEach((item) => {
        item.addEventListener("click", async (e) => {
          if (confirm("Delete this video?")) {
            const filename = item.dataset.filename;
            const response = await fetch(`/delete/${filename}`, {
              method: "DELETE",
            });
            if (response.ok) {
              // Remove the item from DOM
              item.remove();

              // Update the count
              const grid = document.querySelector(".video-grid");
              const currentCount =
                document.querySelectorAll(".video-item").length;
              grid.dataset.count = currentCount;

              // If no videos left, show the no-videos message
              if (currentCount === 0) {
                grid.innerHTML = `
                                <div class="no-videos">
                                    <p>No videos yet!</p>
                                    <a href="/record" class="btn-record">Record your first video</a>
                                </div>
                            `;
              } else {
                // Recalculate grid
                calculateOptimalGrid();
              }
            }
          }
        });
      });
    </script>
  </body>
</html>
