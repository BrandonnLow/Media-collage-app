<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Our Time Capsule</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <div class="container">
      <header>
        <div class="header-left">
          <img
            src="{{ url_for('static', filename='images/logo.png') }}"
            alt="Logo"
            class="logo"
          />
        </div>
        <h1 class="header-title">Our Time Capsule</h1>
        <a href="/record" class="btn-record">+ Record New Video</a>
      </header>

      <div class="video-grid" data-count="{{ videos|length }}">
        {% if videos %} {% for video in videos %}
        <div class="video-item" data-filename="{{ video }}">
          <video autoplay muted loop playsinline>
            <source
              src="{{ url_for('static', filename='videos/' + video) }}"
              type="video/mp4"
            />
            Your browser does not support the video tag.
          </video>
        </div>
        {% endfor %} {% else %}
        <div class="no-videos">
          <p>No videos yet!</p>
          <a href="/record" class="btn-record">Record your first video</a>
        </div>
        {% endif %}
      </div>
    </div>

    <script>
      function calculateOptimalGrid() {
        const grid = document.querySelector(".video-grid");
        const videoCount = parseInt(grid.dataset.count) || 0;

        if (videoCount === 0) return;

        // Get the header height
        const header = document.querySelector("header");
        const headerHeight = header.offsetHeight;

        // Calculate available space (full viewport minus header and small padding)
        const padding = 10; // Total padding (5px top/bottom)
        const gap = 5; // Gap between header and grid
        const availableHeight =
          window.innerHeight - headerHeight - padding - gap;
        const availableWidth = window.innerWidth - padding;

        // Find the best grid layout that uses maximum space
        let bestLayout = null;
        let maxVideoArea = 0;

        // Try different column/row combinations
        for (let cols = 1; cols <= videoCount; cols++) {
          const rows = Math.ceil(videoCount / cols);

          // Calculate video size for this layout (accounting for gaps)
          const videoGap = 3;
          const totalGapWidth = (cols - 1) * videoGap;
          const totalGapHeight = (rows - 1) * videoGap;

          const maxVideoWidth = (availableWidth - totalGapWidth) / cols;
          const maxVideoHeight = (availableHeight - totalGapHeight) / rows;

          // Apply 16:9 aspect ratio constraint
          let videoWidth, videoHeight;
          const targetRatio = 16 / 9;

          if (maxVideoWidth / maxVideoHeight > targetRatio) {
            // Height is limiting
            videoHeight = maxVideoHeight;
            videoWidth = videoHeight * targetRatio;
          } else {
            // Width is limiting
            videoWidth = maxVideoWidth;
            videoHeight = videoWidth / targetRatio;
          }

          // Ensure videos fit in available space
          if (
            videoWidth * cols + totalGapWidth <= availableWidth &&
            videoHeight * rows + totalGapHeight <= availableHeight
          ) {
            const area = videoWidth * videoHeight;
            if (area > maxVideoArea) {
              maxVideoArea = area;
              bestLayout = {
                cols: cols,
                rows: rows,
                width: videoWidth,
                height: videoHeight,
                totalWidth: videoWidth * cols + totalGapWidth,
                totalHeight: videoHeight * rows + totalGapHeight,
              };
            }
          }
        }

        // Apply the best layout
        if (bestLayout) {
          // Set fixed dimensions for all video items
          const videoItems = document.querySelectorAll(".video-item");
          videoItems.forEach((item) => {
            item.style.width = `${bestLayout.width}px`;
            item.style.height = `${bestLayout.height}px`;
          });

          // Configure the grid
          grid.style.gridTemplateColumns = `repeat(${bestLayout.cols}, ${bestLayout.width}px)`;
          grid.style.gridTemplateRows = `repeat(${bestLayout.rows}, ${bestLayout.height}px)`;
          grid.style.width = `${bestLayout.totalWidth}px`;
          grid.style.height = `${bestLayout.totalHeight}px`;

          // Center the grid in available space
          grid.style.margin = "auto";
          grid.style.display = "grid";
        }
      }

      // Initial calculation with small delay to ensure DOM is ready
      setTimeout(calculateOptimalGrid, 50);

      // Recalculate on window resize
      let resizeTimeout;
      window.addEventListener("resize", () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(calculateOptimalGrid, 100);
      });

      // Handle click on video to delete
      document.querySelectorAll(".video-item").forEach((item) => {
        item.addEventListener("click", async (e) => {
          if (confirm("Delete this video?")) {
            const filename = item.dataset.filename;
            // Properly encode the filename for the URL
            const encodedFilename = encodeURIComponent(filename);
            const response = await fetch(`/delete/${encodedFilename}`, {
              method: "DELETE",
            });
            if (response.ok) {
              // Remove the item from DOM
              item.remove();

              // Update the count
              const grid = document.querySelector(".video-grid");
              const currentCount =
                document.querySelectorAll(".video-item").length;
              grid.dataset.count = currentCount;

              // If no videos left, show the no-videos message
              if (currentCount === 0) {
                grid.innerHTML = `
                                <div class="no-videos">
                                    <p>No videos yet!</p>
                                    <a href="/record" class="btn-record">Record your first video</a>
                                </div>
                            `;
              } else {
                // Recalculate grid immediately
                setTimeout(calculateOptimalGrid, 50);
              }
            } else {
              // Show error if delete failed
              const error = await response.json();
              alert(
                `Failed to delete video: ${error.error || "Unknown error"}`
              );
            }
          }
        });
      });
    </script>
  </body>
</html>
