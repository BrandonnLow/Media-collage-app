<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Our Time Capsule</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Pacifico&family=Comfortaa:wght@700&family=Righteous&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <div class="container">
      <header>
        <div class="header-left">
          <img
            src="{{ url_for('static', filename='images/logo.png') }}"
            alt="Logo"
            class="logo"
          />
        </div>
        <h1 class="time-capsule-title">Our Time Capsule</h1>
        <a href="/record" class="btn-record">+ Record New Video</a>
      </header>

      <!-- Pagination Info Display -->
      {% if pagination.total_videos > 0 %}
      <div class="pagination-info">
        <span
          >Page {{ pagination.current_page }} of {{ pagination.total_pages
          }}</span
        >
        <span class="separator">|</span>
        <span
          >Videos {{ pagination.start_idx }}-{{ pagination.end_idx }} of {{
          pagination.total_videos }}</span
        >
      </div>
      {% endif %}

      <div class="video-grid" data-count="{{ videos|length }}">
        {% if videos %} {% for video in videos %}
        <div class="video-item" data-filename="{{ video }}">
          <video autoplay muted loop playsinline>
            <source
              src="{{ url_for('static', filename='videos/' + video) }}"
              type="video/mp4"
            />
            Your browser does not support the video tag.
          </video>
        </div>
        {% endfor %} {% else %} {% if pagination.current_page > 1 %}
        <!-- Empty page (not the first page) -->
        <div class="no-videos">
          <p>No videos on this page</p>
          <a href="/?page=1" class="btn-record">‚Üê Back to first page</a>
        </div>
        {% else %}
        <!-- No videos at all -->
        <div class="no-videos">
          <p>No videos yet!</p>
          <a href="/record" class="btn-record">Record your first video</a>
        </div>
        {% endif %} {% endif %}
      </div>
    </div>

    <!-- Navigation Arrows -->
    {% if pagination.total_pages > 1 %}
    <nav class="page-navigation">
      {% if pagination.has_prev %}
      <a
        href="/?page={{ pagination.prev_page }}"
        class="nav-arrow nav-prev"
        title="Previous Page"
      >
        <div class="arrow-container">
          <svg
            width="40"
            height="40"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M15 18L9 12L15 6"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <span class="page-label">Page {{ pagination.prev_page }}</span>
        </div>
      </a>
      {% endif %} {% if pagination.has_next %}
      <a
        href="/?page={{ pagination.next_page }}"
        class="nav-arrow nav-next"
        title="Next Page"
      >
        <div class="arrow-container">
          <svg
            width="40"
            height="40"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M9 18L15 12L9 6"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <span class="page-label">Page {{ pagination.next_page }}</span>
        </div>
      </a>
      {% endif %}
    </nav>
    {% endif %}

    <script>
      function calculateOptimalGrid() {
        const grid = document.querySelector(".video-grid");
        const videoCount = parseInt(grid.dataset.count) || 0;

        if (videoCount === 0) return;

        // Get the header height and pagination info height
        const header = document.querySelector("header");
        const paginationInfo = document.querySelector(".pagination-info");
        const headerHeight = header.offsetHeight;
        const paginationHeight = paginationInfo
          ? paginationInfo.offsetHeight
          : 0;

        // Calculate available space
        const padding = 10;
        const gap = 5;
        const availableHeight =
          window.innerHeight -
          headerHeight -
          paginationHeight -
          padding -
          gap * 2;
        const availableWidth = window.innerWidth - padding;

        // Find the best grid layout
        let bestLayout = null;
        let maxVideoArea = 0;

        for (let cols = 1; cols <= videoCount; cols++) {
          const rows = Math.ceil(videoCount / cols);

          const videoGap = 3;
          const totalGapWidth = (cols - 1) * videoGap;
          const totalGapHeight = (rows - 1) * videoGap;

          const maxVideoWidth = (availableWidth - totalGapWidth) / cols;
          const maxVideoHeight = (availableHeight - totalGapHeight) / rows;

          let videoWidth, videoHeight;
          const targetRatio = 16 / 9;

          if (maxVideoWidth / maxVideoHeight > targetRatio) {
            videoHeight = maxVideoHeight;
            videoWidth = videoHeight * targetRatio;
          } else {
            videoWidth = maxVideoWidth;
            videoHeight = videoWidth / targetRatio;
          }

          if (
            videoWidth * cols + totalGapWidth <= availableWidth &&
            videoHeight * rows + totalGapHeight <= availableHeight
          ) {
            const area = videoWidth * videoHeight;
            if (area > maxVideoArea) {
              maxVideoArea = area;
              bestLayout = {
                cols: cols,
                rows: rows,
                width: videoWidth,
                height: videoHeight,
                totalWidth: videoWidth * cols + totalGapWidth,
                totalHeight: videoHeight * rows + totalGapHeight,
              };
            }
          }
        }

        if (bestLayout) {
          const videoItems = document.querySelectorAll(".video-item");
          videoItems.forEach((item) => {
            item.style.width = `${bestLayout.width}px`;
            item.style.height = `${bestLayout.height}px`;
          });

          grid.style.gridTemplateColumns = `repeat(${bestLayout.cols}, ${bestLayout.width}px)`;
          grid.style.gridTemplateRows = `repeat(${bestLayout.rows}, ${bestLayout.height}px)`;
          grid.style.width = `${bestLayout.totalWidth}px`;
          grid.style.height = `${bestLayout.totalHeight}px`;
          grid.style.margin = "auto";
          grid.style.display = "grid";
        }
      }

      // Initial calculation
      setTimeout(calculateOptimalGrid, 50);

      // Recalculate on window resize
      let resizeTimeout;
      window.addEventListener("resize", () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(calculateOptimalGrid, 100);
      });

      // Handle click on video to delete
      document.querySelectorAll(".video-item").forEach((item) => {
        item.addEventListener("click", async (e) => {
          if (confirm("Delete this video?")) {
            const filename = item.dataset.filename;
            const encodedFilename = encodeURIComponent(filename);
            const response = await fetch(`/delete/${encodedFilename}`, {
              method: "DELETE",
            });
            if (response.ok) {
              // Get current page from URL
              const urlParams = new URLSearchParams(window.location.search);
              const currentPage = urlParams.get("page") || "1";

              // Reload the current page to refresh the video list
              window.location.href = `/?page=${currentPage}`;
            } else {
              const error = await response.json();
              alert(
                `Failed to delete video: ${error.error || "Unknown error"}`
              );
            }
          }
        });
      });

      // Keyboard navigation support
      document.addEventListener("keydown", (e) => {
        if (e.key === "ArrowLeft") {
          const prevArrow = document.querySelector(".nav-prev");
          if (prevArrow) {
            prevArrow.click();
          }
        } else if (e.key === "ArrowRight") {
          const nextArrow = document.querySelector(".nav-next");
          if (nextArrow) {
            nextArrow.click();
          }
        }
      });
    </script>
  </body>
</html>
